name: Build Linux Packages

on:
  push:
    branches:
      - master
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - dockerimg: ubuntu2004
            pkgtype: deb
          - dockerimg: ubuntu2204
            pkgtype: deb
          - dockerimg: ubuntu2404
            pkgtype: deb

    env:
      DOCKER_FILE:  docker/docker_${{ matrix.dockerimg }} # legacy (unused after change)
      DOCKER_IMAGE: ${{ matrix.dockerimg }}
      PKG_TYPE: ${{ matrix.pkgtype }}
      BASE_IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/rkmppenc-build

    name: Upload Release Asset
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Prepare
        id: prep
        run: |
          REPOSITORY=$(echo ${{ github.repository }} | sed -e "s#.*/##")
          VERSION=$(echo ${{ github.ref }} | sed -e "s#refs/tags/##g")
          IMAGE="build_rkmppenc_"${{ env.DOCKER_IMAGE }}
          TAG=$(echo $GITHUB_SHA | head -c7)
          NPROC=$(grep 'processor' /proc/cpuinfo | wc -l)
          OUTPUT_DIR=`pwd`/../output
          LOCAL_USER_ID=$(id -u)
          LOCAL_GROUP_ID=$(id -g)
          echo "tagged_image=${IMAGE}:${TAG}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "nproc=${NPROC}" >> $GITHUB_OUTPUT
          echo "output_dir=${OUTPUT_DIR}" >> $GITHUB_OUTPUT
          echo "local_user_id=${LOCAL_USER_ID}" >> $GITHUB_OUTPUT
          echo "local_group_id=${LOCAL_GROUP_ID}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Verify tag matches VER_STR_FILEVERSION
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd ${{ github.workspace }}
          TAG=$(echo ${{ github.ref }} | sed -e "s#refs/tags/##g")
          VER=$(sed -n 's/^#define VER_STR_FILEVERSION[ \t]*"\(.*\)"/\1/p' mppcore/rgy_version.h)
          if [ "$TAG" = "$VER" ] || [ "${TAG#v}" = "$VER" ]; then
            echo "Version OK: tag=${TAG}, header=${VER}"
          else
            echo "ERROR: Tag version (${TAG}) does not match VER_STR_FILEVERSION (${VER})" >&2
            exit 1
          fi

      - name: Checkout dependencies
        run: |
          git clone --depth 1 https://github.com/AviSynth/AviSynthPlus.git AviSynthPlus
          git clone -b R72 --depth 1 https://github.com/vapoursynth/vapoursynth.git vapoursynth

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Output Dir
        run: |
          mkdir -p ${{ steps.prep.outputs.output_dir }}

      - name: Build Exec
        id: build_exec
        run: |
          docker run -dit --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/work \
            -v ${{ steps.prep.outputs.output_dir }}:/output \
            --name build_pkg ${{ env.BASE_IMAGE_REPO }}:${{ env.DOCKER_IMAGE }}
          docker exec build_pkg bash -lc "cd /work && ./configure --libav-static --extra-cxxflags='-I./AviSynthPlus/avs_core/include -I./vapoursynth/include' --enable-lto"
          docker exec build_pkg bash -lc "cd /work && make -j${{ steps.prep.outputs.nproc }}"
          docker exec build_pkg bash -lc "cd /work && ./rkmppenc --version"
          docker exec build_pkg bash -lc "cd /work && ./check_options.py"
          docker exec build_pkg bash -lc "cd /work && ./build_${{ env.PKG_TYPE }}.sh"
          docker exec build_pkg bash -lc "cd /work && cp -v ./*.${{ env.PKG_TYPE }} /output/"
          PKGFILE=`ls ${{ steps.prep.outputs.output_dir }}/*.${{ env.PKG_TYPE }}`
          echo ${PKGFILE}
          echo "pkgfile=${PKGFILE}" >> $GITHUB_OUTPUT

      - name: Normalize path and get filename
        id: normalize_path
        run: |
          normalized_path=$(realpath "${{ steps.build_exec.outputs.pkgfile }}")
          filename=$(basename "${{ steps.build_exec.outputs.pkgfile }}")
          echo "Normalized path: $normalized_path"
          echo "Filename: $filename"
          echo "normalized_path=$normalized_path" >> $GITHUB_OUTPUT
          echo "filename=$filename" >> $GITHUB_OUTPUT

      - name: Calc hash
        id: calc_hash
        run: |
          7z h -scrc* ${{ steps.build_exec.outputs.pkgfile }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.normalize_path.outputs.filename }}
          path: ${{ steps.normalize_path.outputs.normalized_path }}

      - name: Upload Release Asset
        id: upload-release-asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ steps.build_exec.outputs.pkgfile }}
